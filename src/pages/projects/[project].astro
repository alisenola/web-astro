---
// <% content_for(:title, project.title) %>
// <% content_for(:description, project.description) %>
// <% content_for(:page_image, "https://#{config.domain}/assets/projects/#{project_name}/thumb.jpg") %>


import MainLayout from "../../layouts/MainLayout.astro";
import CBImage from "../../components/content_blocks/CB_Image.astro";

export async function getStaticPaths() {
	const projectList = (await Astro.glob('../../data/project_index.yml'))[0]["default"];
	const projectData = import.meta.glob('../../data/projects/*');

	let paths = [];
	for (let i = 0; i < projectList.length; i++)
	{
		const projectName = projectList[i];
		const dataPath = '../../data/projects/' + projectName + '.yml';

		paths.push({
			params: {
				project: projectName,
			},
			props: {
				data: await projectData[dataPath]()
			}
		});
	}

	return paths;
}

const {project} = Astro.params;
const {data} = Astro.props;
// console.log(data.page);

const contentBlockComponents = {
	'image': CBImage
}

let contentBlocks = [];
for (let i = 0; i < data.page.length; i++)
{
	const inData = data.page[i];
	// console.log(inData.type);
	if (!(inData.type in contentBlockComponents))
	{
		console.error('Unknown content block type: ' + inData.type);
		continue;
	}

	const outData = {};
	outData['component'] = contentBlockComponents[inData.type];
	outData['item'] = inData;

	contentBlocks.push(outData);
}

// console.log(contentBlocks);
// console.log(data.page);

---

<MainLayout>

<div class="project-detail-wrapper">
	<div class="project-detail">

		<!-- Title -->
		<h1 class="project-title">{data.title}</h1>

		<!-- Tags -->
		<div class="tag-wrapper">
			<div class="tag-row">
			{data.tags.map((tag) => {
				return <div class="tag">{tag}</div>
			})}
			</div>
		</div>
		
		<!-- Links -->
		{data.links && (
			<div>
				<div class="tag-wrapper">
				{data.links.map((link) => (
					<>
						<a class="tile link" href={link.link} target="_blank">
							<img class="link-tile-icon" src="/assets/svg/external-link-alt.svg"/>
							<div class="link-tile-text">{link.title}</div>
						</a>
					</>
				))}
				</div>
			</div>
		)}

		<!-- Content blocks -->

		{contentBlocks.map((block, index) => {
			let Component = block.component;
			return <Component
				item={block.item}
				project={project}
				index={index}
				links_exist={'links' in data}
			/>
		})}

		<!-- <% project.page.each_with_index  do |item, index| %>
			<%= partial "partials/content_blocks/#{item.type}", :locals => {
				:project_name => project_name,
				:item => item,
				:index => index,
				:links_exist => project.links.present?
			} %>
		<% end %> -->

	</div>
</div>
<div class="back-to-projects-wrapper">
	<!-- <%= partial 'partials/components/projects_button', :locals => {
		:text => 'Back to projects'
	} %> -->
</div>

</MainLayout>

<script is:inline src="/src/javascripts/project_detail.js"></script>

<style is:global>
.project-detail-wrapper {
	max-width: 1000px;
	margin: 30px auto;
}

@media (min-width: 2100px) {
	.project-detail-wrapper {
		max-width: 1200px;
	}
}

.project-detail {
	padding: 0 52px;
	text-align: center;
	min-height: calc(100vh - 366px);
}

.project-detail h1 {
	text-align: center;
}

.project-detail iframe, .project-detail video {
	position: absolute;
	top: 0;
	left: 0;
	width: 100%;
	height: 100%;
}

.project-detail p {
	padding: 22px 30px;
	margin: 0px 0px -5px;
    position: relative;
	top: -5px;
}

.textarea {
	color: #222;
	background: #fff;
    border: 1px solid #ccc;
	border-radius: 5px;
    line-height: normal;
}

.project-detail p {
	text-align: left;
}

.project-detail .content-description {
	margin-top: 0px;
	margin-left: auto;
	margin-right: auto;
	line-height: initial;
}

.project-detail p.project-description {
	margin-top: 0px;
	margin-bottom: 20px;
}

.content-block {
	margin: 30px auto;
	line-height: 0;
}

.aspect-container {
	position: relative;
	display: inline-block;
	line-height: 0;
	
	background: #eee;
	background-position: center;
	background-repeat: no-repeat;
}

.project-detail-image {
	/* display: none; */
	width: 100%;
	height: 100%;
}

.back-to-projects-wrapper {
	text-align: center;
	margin: 44px 0px 50px;
}

.media-controls {
	position: absolute;
	width: 100%;
	bottom: 10px;

	opacity: 0;
	transition: opacity 0.5s ease;
}

.media-controls.has-description {
	bottom: 15px;
}

.aspect-container:hover .media-controls {
	opacity: 1;
}

.media-controls .tile {
	padding: 12px 14px;
}

.media-controls .tile-icon {
	height: 21px;
}

.media-controls .tile-icon img {
	height: 21px;
	width: 21px;
}

.project-title {
	margin: 0.2em 0;
	font-size: 45px;
}

.tag-wrapper {
	margin-bottom: 20px;
	display: flex;
    justify-content: center;
}

.tag-row {
	padding: 4px 8px;
}

.tag {
    position: relative;
    font-family: 'Catamaran', sans-serif;
    font-weight: 600;
    display: inline-block;
    font-size: 18px;
	padding: 4px 8px;
	color: #333;
	background: #f0f0f0;
	border-radius: 4px;
}

.border-radius-top,
.border-radius-top iframe,
.border-radius-top video {
	border-radius: 5px 5px 0px 0px;
}

.border-radius-full,
.border-radius-full iframe,
.border-radius-full video {
	border-radius: 5px;
}
</style>